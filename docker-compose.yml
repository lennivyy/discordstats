# /home/discordstats/docker-compose.yml

volumes:
  autopull_work: {}   # можно удалить, если не нужен локальный кэш репо

services:
  git-puller:
    build:
      context: .
      dockerfile: autopull/Dockerfile.autopull
    image: discordstats/git-puller:latest
    working_dir: /work
    environment:
      # --- репозиторий (если он нужен автопуллеру; можно указать свой) ---
      GIT_URL: "${REPO_URL:-https://github.com/lennivyy/discordstats.git}"
      GIT_BRANCH: "${REPO_BRANCH:-main}"
      GIT_LOGIN: "${GIT_LOGIN:-}"
      GIT_TOKEN: "${GIT_TOKEN:-}"

      # --- путь к реальному compose на хосте ---
      COMPOSE_FILE_PATH: "/home/discordstats/docker-compose.yml"

      # --- поведение ---
      POLL_INTERVAL: "20"
      AUTO_BUILD_ON_START: "0"
      AUTOPULL_VERBOSE: "1"
      AUTOPULL_COLOR: "1"
      # DOCKER_COMPOSE_CMD: "docker compose"
    volumes:
      - autopull_work:/work
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/discordstats:/home/discordstats   # ключевое: чтобы env_file и относительные пути из compose работали
    restart: unless-stopped
    init: true
    healthcheck:
      test: ["CMD-SHELL", "git rev-parse HEAD >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 10

  discord-bot:
    build:
      context: .
      dockerfile: Dockerfile
    image: discordstats/discord-bot:latest
    env_file:
      - ./token.env             # резолвится относительно /home/discordstats (compose dir)
    environment:
      MC_WS_URL: ws://bridge:8765
      MC_REALM: anarchy

      # Логи/поведение
      MC_WS_DEBUG: "1"
      MC_WS_LOG_JSON: "1"
      MC_WS_TRUNC: "600"
      MC_IDLE_RECONNECT_SEC: "10"
      MC_CHANNEL_UPDATE_MIN_SEC: "10"
      MC_CHANNEL_SHOW_MSPT: "1"
      MC_FORCE_UPDATE_ON_CHANGE: "1"
      MC_TPS_CHANGE_EPS: "0.05"
      MC_MSPT_CHANGE_EPS: "0.05"

      # Каналы
      MC_ONLINE_CHANNEL_ID: "1434239560526856242"
      MC_TPS_CHANNEL_ID: "1434239613282680934"
    volumes:
      - ./token.env:/app/token.env:ro  # только боту
    restart: unless-stopped
    networks:
      - brigde

networks:
  brigde:
    external: true
    name: brigde
