# docker-compose.yml

volumes:
  autopull_work: {}

services:
  git-puller:
    build:
      context: .
      dockerfile: autopull/Dockerfile.autopull
    working_dir: /work
    environment:
      # --- репозиторий ---
      GIT_URL: "${REPO_URL:-https://github.com/lennivyy/discordstats.git}"
      GIT_BRANCH: "${REPO_BRANCH:-main}"
      GIT_LOGIN: "${GIT_LOGIN:-}"
      GIT_TOKEN: "${GIT_TOKEN:-}"

      # --- реальный путь к compose-файлу ---
      COMPOSE_FILE_PATH: "/home/discordstats/docker-compose.yml"

      # --- поведение ---
      POLL_INTERVAL: "20"
      AUTO_BUILD_ON_START: "0"
      AUTOPULL_VERBOSE: "1"
    volumes:
      - autopull_work:/work
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/discordstats:/home/discordstats   # чтобы контейнер видел compose-файл
    restart: unless-stopped
    init: true
    healthcheck:
      test: ["CMD-SHELL", "git rev-parse HEAD >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 10


  discord-bot:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - ./token.env
    environment:
      # Соединяемся с bridge по внешней сети "brigde"
      MC_WS_URL: ws://bridge:8765
      MC_REALM: anarchy

      # Диагностика / поведение
      MC_WS_DEBUG: "1"
      MC_WS_LOG_JSON: "1"
      MC_WS_TRUNC: "600"
      MC_IDLE_RECONNECT_SEC: "120"
      MC_CHANNEL_UPDATE_MIN_SEC: "10"
      MC_CHANNEL_SHOW_MSPT: "1"
      MC_FORCE_UPDATE_ON_CHANGE: "1"
      MC_TPS_CHANGE_EPS: "0.05"
      MC_MSPT_CHANGE_EPS: "0.05"

      # Фиксированные ID каналов (если уже известны)
      MC_ONLINE_CHANNEL_ID: "1434239560526856242"
      MC_TPS_CHANNEL_ID: "1434239613282680934"

      # Если bridge требует токен, положи его в token.env как MC_WS_TOKEN
      # (env_file его подхватит автоматически)
    volumes:
      - ./token.env:/app/token.env:ro
    restart: unless-stopped
    networks:
      - brigde

networks:
  brigde:
    external: true
    name: brigde
