version: "3.9"

volumes:
  autopull_work: {}   # можно удалить, если не нужен локальный кэш репо

networks:
  app:
    name: discordstats_app
    driver: bridge

services:
  # ───────────── Bridge (WS‑сервер) ─────────────
  bridge:
    image: python:3.11-alpine
    working_dir: /app
    # Ставим websockets и запускаем ваш сервер
    command: sh -c "pip install --no-cache-dir websockets && python bridge.py"
    environment:
      # Токен должен совпадать с MC_WS_TOKEN у бота
      SP_TOKEN: "${SP_TOKEN:-SUPER_SECRET}"
      # Необязательные параметры (bridge.py подтянет их сам, но явно не повредит)
      SP_BRIDGE_HOST: "0.0.0.0"
      SP_BRIDGE_PORT: "8765"
      BRIDGE_VERBOSE: "0"
    volumes:
      - ./bridge:/app:ro
    restart: unless-stopped
    networks:
      - app

  # ───────────── Git puller (autoupdate) ─────────────
  git-puller:
    build:
      context: ./autopull
      dockerfile: Dockerfile.autopull
    image: discordstats/git-puller:latest
    working_dir: /work
    environment:
      # --- репозиторий (можно указать свой) ---
      GIT_URL: "${REPO_URL:-https://github.com/lennivyy/discordstats.git}"
      GIT_BRANCH: "${REPO_BRANCH:-main}"
      GIT_LOGIN: "${GIT_LOGIN:-}"
      GIT_TOKEN: "${GIT_TOKEN:-}"

      # --- путь к реальному compose на хосте ---
      COMPOSE_FILE_PATH: "/home/discordstats/docker-compose.yml"

      # --- поведение ---
      POLL_INTERVAL: "20"
      AUTO_BUILD_ON_START: "0"
      AUTOPULL_VERBOSE: "1"
      AUTOPULL_COLOR: "1"

      # Подсказываем явно, чем пользоваться
      DOCKER_COMPOSE_CMD: "docker compose"

      # Устойчивость
      AUTOPULL_RETRIES: "2"
      RETRY_SLEEP_BASE: "2"
      ALWAYS_REBUILD_ON_COMMIT: "1"
    volumes:
      - autopull_work:/work
      - /var/run/docker.sock:/var/run/docker.sock
      # Ключевое: монтируем корень проекта, чтобы env_file и относительные пути работали
      - /home/discordstats:/home/discordstats
    restart: unless-stopped
    init: true
    healthcheck:
      test: ["CMD-SHELL", "git -C /work rev-parse HEAD >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 10
    networks:
      - app

  # ───────────── Discord bot ─────────────
  discord-bot:
    build:
      context: .
      dockerfile: Dockerfile
    image: discordstats/discord-bot:latest
    env_file:
      - ./token.env
    environment:
      # Подключаемся к нашему сервису bridge внутри сети
      MC_WS_URL: "ws://bridge:8765/ws"
      # Токен должен совпадать с SP_TOKEN у bridge
      MC_WS_TOKEN: "${SP_TOKEN:-SUPER_SECRET}"
      MC_REALM: "anarchy"

      # Логи/поведение
      MC_WS_DEBUG: "1"
      MC_WS_LOG_JSON: "1"
      MC_WS_TRUNC: "600"
      MC_CHANNEL_UPDATE_MIN_SEC: "10"
      MC_CHANNEL_SHOW_MSPT: "1"
      MC_FORCE_UPDATE_ON_CHANGE: "1"
      MC_TPS_CHANGE_EPS: "0.05"
      MC_MSPT_CHANGE_EPS: "0.05"

      # Каналы
      MC_ONLINE_CHANNEL_ID: "1434258641225256992"
      MC_TPS_CHANNEL_ID: "1434258643209027665"
    volumes:
      - ./token.env:/app/token.env:ro
    # чтобы не упираться в права на запись (stats_data.json и т.п.)
    user: "0:0"
    depends_on:
      - bridge
    restart: unless-stopped
    networks:
      - app
